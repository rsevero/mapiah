name: Mapiah Linux Flatpak ARM

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      test_tag:
        description: 'Simulated tag for testing'
        required: false
        default: 'v1.0.0-test'

permissions:
  contents: write

jobs:
  build:
    name: Build Flatpak (ARM)
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate tag (automatic runs only)
      if: github.event_name == 'push'
      shell: bash
      run: |
        set -e
        set -x
        TAG=${GITHUB_REF#refs/tags/}
        if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "::error::Invalid tag format: $TAG (must match vX.Y.Z)"
          exit 1
        fi
        echo "Validated tag: $TAG"

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        flutter-version: 3.38.7

    - name: Install flatpak and flatpak-builder
      run: |
        set -e
        set -x
        sudo add-apt-repository -y ppa:flatpak/stable
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder qemu-user-static
        flatpak --version
        flatpak-builder --version
        qemu-aarch64-static --version

    - name: Install Flatpak Builder dependencies (ARM)
      run: |
        set -e
        set -x
        sudo flatpak remote-add --system --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
        sudo flatpak install --system --noninteractive org.freedesktop.Sdk/aarch64/24.08
        sudo flatpak install --system --noninteractive flathub org.freedesktop.Platform/aarch64/24.08
        sudo flatpak install --system --noninteractive flathub org.freedesktop.Sdk.Extension.llvm19

    - name: Clean host build artifacts
      run: |
        set -e
        rm -rf build

    - name: Build Mapiah flatpak (ARM)
      run: |
        set -e
        set -x
        TAG="${{ github.event_name == 'push' && github.ref_name || github.event.inputs.test_tag }}"
        TAG_NUMBER="${TAG#v}"
        FLATPAK_INSTALLER="Mapiah-${TAG_NUMBER}-linux-aarch64.flatpak"
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "TAG_NUMBER=$TAG_NUMBER" >> $GITHUB_ENV
        echo "FLATPAK_INSTALLER=$FLATPAK_INSTALLER" >> $GITHUB_ENV
        flatpak-builder --force-clean --arch=aarch64 --repo=repo build-dir packaging/linux/flatpak/built-locally/org.mapiah.mapiah.yml
        flatpak build-bundle repo "$FLATPAK_INSTALLER" org.mapiah.mapiah --arch=aarch64

    - name: Publish Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: bash
      run: |
        set -e
        set -x
        TAG="$TAG"
        TITLE="Mapiah $TAG"

        GH_TOKEN=$GITHUB_TOKEN
        unset GITHUB_TOKEN

        gh auth login --with-token <<< "$GH_TOKEN"

        if ! gh release view "$TAG" 2>/dev/null; then
          if ! gh release create "$TAG" \
            --title "$TITLE" \
            --notes "Release $TAG" \
            "$FLATPAK_INSTALLER"; then
            echo "Release creation failed (likely already exists); continuing to upload."
          fi
        fi

        gh release upload "$TAG" \
            --clobber \
            "$FLATPAK_INSTALLER"
